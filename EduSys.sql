CREATE DATABASE EduSys
USE EduSys


CREATE TABLE CHUYENDE (
    MACD NCHAR(5) PRIMARY KEY,
    TENCD NVARCHAR(50) NOT NULL,
    HOCPHI FLOAT NOT NULL,
    THOILUONG INT NOT NULL,
    HINH NVARCHAR(255) NOT NULL,
    MOTA NVARCHAR(255) NOT NULL
)


CREATE TABLE NHANVIEN (
    MANV NVARCHAR(20) PRIMARY KEY,
    MATKHAU NVARCHAR(50) NOT NULL,
    HOTEN NVARCHAR(50) NOT NULL,
    VAITRO BIT DEFAULT 0
)


CREATE TABLE KHOAHOC (
    MAKH INT PRIMARY KEY IDENTITY(1,1),
    MACD NCHAR(5) REFERENCES CHUYENDE(MACD)  ON DELETE NO ACTION ON UPDATE CASCADE,
    HOCPHI FLOAT NOT NULL,
    THOILUONG INT NOT NULL,
    NGAYKG DATE NOT NULL,
    GHICHU NVARCHAR(255) NULL,
    MANV NVARCHAR(20) REFERENCES NHANVIEN(MANV) ON DELETE NO ACTION ON UPDATE CASCADE,
    NGAYDK DATE DEFAULT GETDATE()
)


CREATE TABLE NGUOIHOC (
    MANH NCHAR(7) PRIMARY KEY,
    HOTEN NVARCHAR(50) NOT NULL,
    GIOITINH BIT DEFAULT 1,
    NGAYSINH DATE NOT NULL,
    DIENTHOAI NVARCHAR(24) NOT NULL,
    EMAIL NVARCHAR(50) NOT NULL,
    GHICHU NVARCHAR(255) NULL,
    MANV NVARCHAR(20) REFERENCES NHANVIEN(MANV) ON DELETE NO ACTION ON UPDATE CASCADE,
    NGAYDK DATE DEFAULT GETDATE()
)

CREATE TABLE HOCVIEN (
    MAHV INT PRIMARY KEY IDENTITY(1,1),
    MAKH INT REFERENCES KHOAHOC(MAKH) ON DELETE CASCADE ON UPDATE NO ACTION,
    MANH NCHAR(7) REFERENCES NGUOIHOC(MANH)  ON DELETE NO ACTION ON UPDATE CASCADE,
    DIEM FLOAT DEFAULT -1
)
drop table HOCVIEN
drop table NGUOIHOC
drop table KHOAHOC
drop table NHANVIEN
drop table CHUYENDE

INSERT INTO CHUYENDE (MACD, TENCD, HOCPHI, THOILUONG, HINH, MOTA) VALUES
('CD001', N'Chuyên đề 1', 1500000, 30, 'hinh_cd1.jpg', N'Mô tả chuyên đề 1'),
('CD002', N'Chuyên đề 2', 1800000, 45, 'hinh_cd2.jpg', N'Mô tả chuyên đề 2'),
('CD003', N'Chuyên đề 3', 2000000, 40, 'hinh_cd3.jpg', N'Mô tả chuyên đề 3'),
('CD004', N'Chuyên đề 1', 300000, 37, 'hinh_cd76.jpg', N'Mô tả chuyên đề 1'),
('CD005', N'Chuyên đề 2', 100000, 45, 'hinh_cd7.jpg', N'Mô tả chuyên đề 2'),
('CD006', N'Chuyên đề 6', 1900000, 55, 'hinh_cd6.jpg', N'Mô tả chuyên đề 6'),
('CD007', N'Chuyên đề 7', 2200000, 30, 'hinh_cd7.jpg', N'Mô tả chuyên đề 7'),
('CD008', N'Chuyên đề 8', 1300000, 40, 'hinh_cd8.jpg', N'Mô tả chuyên đề 8'),
('CD009', N'Chuyên đề 9', 2400000, 35, 'hinh_cd9.jpg', N'Mô tả chuyên đề 9'),
('CD010', N'Chuyên đề 10', 2100000, 45, 'hinh_cd10.jpg', N'Mô tả chuyên đề 10')
delete from khoahoc where makh = 4
SELECT  MACD FROM CHUYENDE WHERE TENCD LIKE N'Chuyên đề 2'
INSERT INTO NHANVIEN (MANV, MATKHAU, HOTEN, VAITRO) VALUES
('NV001', 'pass123', N'Nguyễn Văn A', 1),
('NV002', 'pass456', N'Trần Thị B', 0),
('NV003', 'pass789', N'Lê Quang C', 0),
('NV004', 'passabc', N'Hoàng Thị D', 0),
('NV005', 'passdef', N'Đỗ Văn E', 0),
('NV006', 'passghi', N'Lý Thị F', 0),
('NV007', 'passjkl', N'Phạm Văn G', 0),
('NV008', 'passmno', N'Nguyễn Thị H', 0),
('NV009', 'passpqr', N'Trần Văn I', 0),
('NV010', 'passtu', N'Lê Thị K', 0)

DELETE FROM KHOAHOC WHERE MAKH = 20
INSERT INTO KHOAHOC (MACD, HOCPHI, THOILUONG, NGAYKG, GHICHU, MANV, NGAYDK) VALUES
('CD005', 1500000, 30, '2021-01-15', N'Ghi chú khóa học 1', 'NV001', '2022-01-01'),
('CD010', 1500000, 30, '2022-01-15', N'Ghi chú khóa học 1', 'NV001', '2024-01-01'),
('CD001', 1500000, 30, '2023-01-15', N'Ghi chú khóa học 1', 'NV001', '2023-01-01'),
('CD002', 1800000, 45, '2023-02-20', N'Ghi chú khóa học 2', 'NV002', '2023-02-01'),
('CD003', 2000000, 40, '2023-03-10', N'Ghi chú khóa học 3', 'NV003', '2023-03-01'),
('CD004', 1700000, 35, '2023-04-05', N'Ghi chú khóa học 4', 'NV004', '2023-04-01'),
('CD006', 1900000, 55, '2023-06-20', N'Ghi chú khóa học 6', 'NV006', '2023-06-01'),
('CD007', 2200000, 30, '2023-07-15', N'Ghi chú khóa học 7', 'NV007', '2023-07-01'),
('CD008', 1300000, 40, '2023-08-10', N'Ghi chú khóa học 8', 'NV008', '2023-08-01'),
('CD009', 2400000, 35, '2023-09-05', N'Ghi chú khóa học 9', 'NV009', '2023-09-01'),
('CD010', 2100000, 45, '2023-10-12', N'Ghi chú khóa học 10', 'NV010', '2023-10-01'),

SELECT * FROM KHOAHOC WHERE MACD = 'CD004'
select * from NGUOIHOC
SELECT * FROM KHOAHOC WHERE MAKH = 2
INSERT INTO NGUOIHOC (MANH, HOTEN, GIOITINH, NGAYSINH, DIENTHOAI, EMAIL, GHICHU, MANV, NGAYDK) VALUES
('NH001', N'Nguyễn Thị C', 1, '1990-05-12', '0987654321', 'nguyenthic@gmail.com', N'Ghi chú người học 1', 'NV001', '2023-03-01'),
('NH002', N'Lê Văn D', 0, '1988-10-05', '0123456789', 'levand@gmail.com', N'Ghi chú người học 2', 'NV002', '2023-04-01'),
('NH003', N'Phạm Thị E', 1, '1995-02-28', '0909090909', 'phamthie@gmail.com', N'Ghi chú người học 3', 'NV003', '2023-05-01'),
('NH004', N'Hoàng Văn F', 0, '1993-07-15', '0789654321', 'hoangvanf@gmail.com', N'Ghi chú người học 4', 'NV004', '2023-06-01'),
('NH006', N'Lý Văn H', 0, '1991-04-08', '0978654321', 'lyvanh@gmail.com', N'Ghi chú người học 6', 'NV006', '2023-08-01'),
('NH007', N'Phạm Thị I', 1, '1996-11-30', '0123456798', 'phamthii@gmail.com', N'Ghi chú người học 7', 'NV007', '2023-09-01'),
('NH008', N'Nguyễn Văn K', 0, '1994-06-22', '0956781234', 'nguyenvank@gmail.com', N'Ghi chú người học 8', 'NV008', '2023-10-01'),
('NH009', N'Trần Thị L', 1, '1997-03-17', '0765432198', 'tranthil@gmail.com', N'Ghi chú người học 9', 'NV009', '2023-11-01'),
('NH010', N'Lê Thị M', 0, '1992-08-05', '0998765432', 'lethim@gmail.com', N'Ghi chú người học 10', 'NV010', '2023-12-01')
delete from khoahoc where makh = 1
SELECT * FROM KHOAHOC WHERE MACD = 'CD001'
select * from HOCVIEN
DELETE FROM HOCVIEN WHERE MAHV = 9
INSERT INTO HOCVIEN (MAKH, MANH, DIEM) VALUES
(1, 'NH001', 8.5),
(2, 'NH002', 7.8),
(3, 'NH003', 9.0),
(4, 'NH006', 8.9),
(5, 'NH007', 9.5),
(6, 'NH008', 8.7),
(7, 'NH009', 7.3),
(9, 'NH010', 9.2)

CREATE PROC SP_BANGDIEM(@MAKH INT)
AS BEGIN
	SELECT 
		B.MANH,
		B.HOTEN,
		A.DIEM
	FROM HocVien A
		inner JOIN NguoiHoc B ON B.MANH=A.MANH
	WHERE A.MAKH = @MAKH
	ORDER BY A.DIEM DESC
END
drop proc SP_BANGDIEM
execute SP_BANGDIEM 3
CREATE PROC SP_DOANHTHU (@YEAR INT)
AS BEGIN
		SELECT TENCD AS CHUYENDE,
				COUNT(DISTINCT A.MAKH) AS SOKH,
				COUNT(B.MAHV) AS SOHV,
				SUM(A.HOCPHI) AS DOANHTHU,
				MAX(A.HOCPHI) AS CAONHAT,
				MIN(A.HOCPHI) AS THAPNHAT,
				AVG(A.HOCPHI) AS TRUNGBINH
		FROM KHOAHOC A
		INNER JOIN HOCVIEN B ON A.MAKH = B.MAHV
		INNER JOIN CHUYENDE C ON A.MACD = C.MACD
		WHERE YEAR(A.NGAYKG) = @YEAR
		GROUP BY TENCD
END
CREATE PROC SP_LUONGNGUOIHOC 
AS BEGIN
		SELECT YEAR(NGAYDK) AS NAM,
				COUNT(*) AS SOLUONG,
				MIN(NGAYDK) AS DAUTIEN,
				MAX(NGAYDK) AS CUOICUNG
		FROM NGUOIHOC
		GROUP BY YEAR(NGAYDK)
END
CREATE PROC SP_DIEMCHUYENDE
AS BEGIN
		SELECT TENCD AS CHUYENDE,
				COUNT(DISTINCT A.MAKH) AS SOHV,
				MAX(DIEM) AS CAONHAT,
				MIN(DIEM) AS THAPNHAT,
				AVG(DIEM) AS TRUNGBINH
		FROM KHOAHOC A
		INNER JOIN HOCVIEN B ON A.MAKH = B.MAHV
		INNER JOIN CHUYENDE C ON A.MACD = C.MACD
		GROUP BY TENCD
END
DROP PROC SP_DIEMCHUYENDE
